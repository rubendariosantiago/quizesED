<!DOCTYPE html>
<html>
<head>
  <title>Examen Parametrizado: EDO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f2f2f2; }
    h1 { color: #003366; }
    .question { background: #fff; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    .feedback { margin-top: 10px; font-weight: bold; }
    .correct { color: green; }
    .incorrect { color: red; }
    input[type="text"] { width: 100%; padding: 8px; font-size: 16px; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 20px; }
    label { display: block; margin-bottom: 8px; }
  </style>
</head>
<body>

<h1>Examen de Ecuaciones Diferenciales</h1>
<div id="quiz"></div>
<button onclick="submitExam()">Enviar respuestas</button>
<div id="result"></div>
<button onclick="location.reload()">Nuevo examen</button>

<script>
const PRACTICAL_TYPES = [1, 2, 3, 4];
const TOL = 1e-2;

function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function pickRandom(arr, n) {
  return arr.sort(() => 0.5 - Math.random()).slice(0, n);
}

// ---------------------- Preguntas prácticas ----------------------
function generatePracticalQuestion(type) {
  const a = randInt(2, 5);
  const b = randInt(2, 5);
  const c = randInt(2, 4);
  const d = randInt(1, 5);

  let questionText = "";
  let solutionExpr = "";

  switch (type) {
    case 1:
      // y' + a y = b x + c
      questionText = `Resuelve: \\( y' + ${a}y = ${b}x + ${c},\\quad y(0) = ${d} \\)`;
      const genSol1 = `-(${b}/(${a}*${a}) + ${c}/${a} + ${b}/(${a}^2*exp(${a}*x)) - ${c}/(${a}*exp(${a}*x)) + ${d}/exp(${a}*x) + (${b}*x)/${a}';
      solutionExpr = genSol1;
      break;
    case 2:
      // y' + a y = b exp(-a x)
      questionText = `Resuelve: \\( y' + ${a}y = ${b}e^{- ${a}x},\\quad y(0) = ${d} \\)`;
      const genSol2 = `${d}*exp(-${a}*x) + ${b}*x*exp(-${a}*x)`;
      solutionExpr = genSol2;
      break;
    case 3:
      // y' + a y = b exp(c x), c ≠ -a
      let c2 = c;
      while (c2 === -a) c2 = randInt(1, 4);
      questionText = `Resuelve: \\( y' + ${a}y = ${b}e^{${c2}x},\\quad y(0) = ${d} \\)`;
      const genSol3 = `((${a} + ${c2})*${d} + ${b}*(-1 + exp(( ${a} + ${c2} )*x)))/((${a} + ${c2})*exp(${a}*x))`;
      solutionExpr = genSol3;
      break;
    case 4:
      // y' + a y = cos(b x)
      questionText = `Resuelve: \\( y' + ${a}y = cos(${b}x),\\quad y(0) = ${d} \\)`;
      const denom = `${a}^2 + ${b}^2`;
      const genSol4 = `(${a}*cos(${b}*x) + ${b}*sin(${b}*x))/${denom} + (${denom}*$d$ - ${a})/(${denom})*exp(-${a}*x)`;
  solutionExpr = genSol4;
      break;
  }

  return {
    text: questionText,
    solution: solutionExpr,
    id: `practical${type}`
  };
}

// ---------------------- Preguntas teóricas ----------------------
const THEORY_BANK = [
  {
    question: "¿Cuál es la forma general de una ED lineal de primer orden?",
    options: ["y' + p(x)y = q(x)", "y'' + p(x)y' = q(x)", "y = Ce^{ax}", "y = mx + b"],
    answer: 0
  },
  {
    question: "¿Cuál es el método más común para resolver una ED lineal de primer orden?",
    options: ["Separación de variables", "Transformada de Laplace", "Factor integrante", "Series de potencias"],
    answer: 2
  },
  {
    question: "¿Cuál es la solución general de y' + ay = 0?",
    options: ["y = Ce^{-ax}", "y = ax + C", "y = Cx^a", "y = Ce^{ax}"],
    answer: 0
  },
  {
    question: "¿Qué representa una solución particular?",
    options: [
      "Una solución con condiciones iniciales",
      "Una solución general",
      "Una constante de integración",
      "Una solución numérica"
    ],
    answer: 0
  },
  {
    question: "¿Qué condición debe cumplirse para aplicar factor integrante?",
    options: [
      "La ED debe estar escrita como y'' + p(x)y' = q(x)",
      "La ED debe ser de segundo orden",
      "La ED debe ser lineal y de primer orden",
      "Debe tener solución exacta"
    ],
    answer: 2
  }
];

function generateTheoryQuestions(n) {
  return pickRandom(THEORY_BANK, n).map((item, idx) => ({
    ...item,
    id: `theory${idx}`
  }));
}

// ---------------------- Renderizado ----------------------
const practicalQuestions = pickRandom(PRACTICAL_TYPES, 3).map(generatePracticalQuestion);
const theoryQuestions = generateTheoryQuestions(2);

function renderQuiz() {
  const container = document.getElementById('quiz');

  practicalQuestions.forEach(q => {
    container.innerHTML += `
      <div class="question">
        <p><strong>${q.text}</strong></p>
        <label>Ingresa tu respuesta en notación matemática (en función de x):</label>
        <input type="text" id="${q.id}">
        <div id="${q.id}_feedback" class="feedback"></div>
      </div>`;
  });

  theoryQuestions.forEach((q, i) => {
    let optionsHTML = q.options.map((opt, idx) => `
      <label><input type="radio" name="${q.id}" value="${idx}"> ${opt}</label>
    `).join('');
    container.innerHTML += `
      <div class="question">
        <p><strong>${q.question}</strong></p>
        ${optionsHTML}
        <div id="${q.id}_feedback" class="feedback"></div>
      </div>`;
  });
}

renderQuiz();

// ---------------------- Evaluación ----------------------
function exprMatches(userExpr, expectedExpr) {
  try {
    const x = randInt(1, 3);
    const u = math.evaluate(userExpr, { x });
    const e = math.evaluate(expectedExpr, { x });
    return Math.abs(u - e) < TOL;
  } catch {
    return false;
  }
}

function submitExam() {
  let score = 0;

  // Evaluar prácticas
  practicalQuestions.forEach(q => {
    const input = document.getElementById(q.id).value;
    const fb = document.getElementById(`${q.id}_feedback`);
    if (exprMatches(input, q.solution)) {
      fb.textContent = "✅ Correcto";
      fb.className = "feedback correct";
      score++;
    } else {
      fb.textContent = `❌ Incorrecto. Solución esperada (forma simbólica equivalente a): ${q.solution}`;
      fb.className = "feedback incorrect";
    }
  });

  // Evaluar teóricas
  theoryQuestions.forEach(q => {
    const selected = document.querySelector(`input[name="${q.id}"]:checked`);
    const fb = document.getElementById(`${q.id}_feedback`);
    if (selected && parseInt(selected.value) === q.answer) {
      fb.textContent = "✅ Correcto";
      fb.className = "feedback correct";
      score++;
    } else {
      fb.textContent = `❌ Incorrecto. Respuesta correcta: ${q.options[q.answer]}`;
      fb.className = "feedback incorrect";
    }
  });

  document.getElementById('result').innerHTML =
    `<h3>Calificación final: ${score} / 5</h3>`;
}
</script>

</body>
</html>
